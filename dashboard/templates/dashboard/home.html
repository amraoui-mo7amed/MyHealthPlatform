{% extends "dashboard/index.html" %}

{% load static i18n tags %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}?v={% now 'U' %}" />
    <link rel="stylesheet"
          href="{% static 'css/admin_dashboard.css' %}?v={% now 'U' %}" />
{% endblock extra_css %}

{% block subtitle %}
    {% trans "Home" %}
{% endblock subtitle %}

{% block dashtitle %}
{% endblock dashtitle %}

{% block dash %}
    <!-- DOCTOR section -->
    {% if role == 'DOCTOR' %}
        <div id="diet_requests">
            <h3 class="text-teal">
                {% trans "Diet requests" %}
            </h3>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            <button class="nav-link active"
                                    id="nav-verified-tab"
                                    data-bs-toggle="tab"
                                    data-bs-target="#nav-verified"
                                    type="button"
                                    role="tab"
                                    aria-controls="nav-verified"
                                    aria-selected="true">
                                {% trans "Verified Requests" %}
                            </button>
                            <button class="nav-link"
                                    id="nav-updates-tab"
                                    data-bs-toggle="tab"
                                    data-bs-target="#nav-updates"
                                    type="button"
                                    role="tab"
                                    aria-controls="nav-updates"
                                    aria-selected="false">
                                {% trans "Unverified Requests" %}
                            </button>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="tab-content" id="nav-tabContent">
                            <!-- Verified Requests Pane -->
                            <div class="tab-pane fade show active"
                                 id="nav-verified"
                                 role="tabpanel"
                                 aria-labelledby="nav-verified-tab">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>
                                                    {% trans "Patient Name" %}
                                                </th>
                                                <th>
                                                    {% trans "Date Created" %}
                                                </th>
                                                <th>
                                                    {% trans "BMI Value" %}
                                                </th>
                                                <th>
                                                    {% trans "Status" %}
                                                </th>
                                                <th>
                                                    {% trans "Actions" %}
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for request in diet_requests %}
                                                {% if request.update_status == 'NONE' %}
                                                    <tr>
                                                        <td>
                                                            {{ request.patient.get_full_name }}
                                                        </td>
                                                        <td>
                                                            {{ request.date_created }}
                                                        </td>
                                                        <td>
                                                            {{ request.bmi.bmi_value }}
                                                        </td>
                                                        <td>
                                                            <span class="text-success">
                                                                <i class="fa fa-check" aria-hidden="true"></i>
                                                                {% trans "Verified" %}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-center ">
                                                                <a href="{% url "doctor:diet-request-details" request.pk %}"
                                                                   class="btn btn-teal btn-sm">
                                                                    {% trans "Details" %}
                                                                </a>
                                                                <button class="btn btn-sm btn-danger delete-button d-block w-100 ms-1"
                                                                        data-delete-url="{% url "doctor:diet-request-delete" request.pk %}"
                                                                        data-csrf-token="{{ csrf_token }}"
                                                                        data-url="{% url 'doctor:diet-request-delete' request.pk %}">
                                                                    {% trans "Delete" %}
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Unvefied Pane -->
                            <div class="tab-pane fade"
                                 id="nav-updates"
                                 role="tabpanel"
                                 aria-labelledby="nav-updates-tab">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>
                                                    {% trans "Patient Name" %}
                                                </th>
                                                <th>
                                                    {% trans "Date Created" %}
                                                </th>
                                                <th>
                                                    {% trans "BMI Value" %}
                                                </th>
                                                <th>
                                                    {% trans "Status" %}
                                                </th>
                                                <th>
                                                    {% trans "Actions" %}
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for request in diet_requests %}
                                                {% if request.update_status == 'PENDING' %}
                                                    <tr>
                                                        <td>
                                                            {{ request.patient.get_full_name }}
                                                        </td>
                                                        <td>
                                                            {{ request.date_created }}
                                                        </td>
                                                        <td>
                                                            {{ request.bmi.bmi_value }}
                                                        </td>
                                                        <td>
                                                            <span class="text-warning">
                                                                <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
                                                                {% comment %} {% trans "Update Requested" %} {% endcomment %}
                                                                {{ request.update_status }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-center ">
                                                                <a href="{% url "doctor:diet-request-details" request.pk %}"
                                                                   class="btn btn-teal btn-sm">
                                                                    {% trans "Details" %}
                                                                </a>
                                                                <button class="btn btn-sm btn-danger delete-button d-block w-100 ms-1"
                                                                        data-delete-url="{% url "doctor:diet-request-delete" request.pk %}"
                                                                        data-csrf-token="{{ csrf_token }}"
                                                                        data-url="{% url 'doctor:diet-request-delete' request.pk %}">
                                                                    {% trans "Delete" %}
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% elif role == 'PATIENT' %}
        <!-- Patient Section: Placeholder for patient-specific content -->
        <div class="container-fluid">
            <div class="container-fluid p-3">
                <div class="row g-4">
                    <!-- Watch and Calendar Section -->
                    <div class="col-lg-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body text-center">
                                <!-- Digital Watch -->
                                <div class="digital-watch mb-4">
                                    <div class="display-3 fw-bold" id="digitalWatch">
                                        00:00:00
                                    </div>
                                    <div class="text-muted" id="currentDate">
                                        Loading date...
                                    </div>
                                </div>

                                <!-- Calendar -->
                                <div class="calendar mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <button class="btn btn-outline-secondary btn-sm" id="prevMonth">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <h5 class="mb-0" id="currentMonthYear">
                                            Month Year
                                        </h5>
                                        <button class="btn btn-outline-secondary btn-sm" id="nextMonth">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="calendar-grid" id="calendarGrid">
                                        <!-- Calendar days will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upcoming Events Section -->
                    <div class="col-lg-8">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h3 class="card-title mb-4">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Upcoming Events
                                </h3>
                                <div class="table-responsive" style="max-height:unset;">
                                    <table class="table table-hover align-middle">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Event</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="upcomingEventsTable">
                                            <!-- Events will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dietDetails">
                {% if patient_diet_request.update_status == 'NONE' and diet %}
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h3 class="text-primary mb-0 text-center">
                            {{ diet.diet_request.patient.get_full_name }}
                            {% trans "Diet" %}
                        </h3>
                        <div class="errorList">
                        </div>

                        {% if diet %}
                            <form action="{% url "patient:reset_diet_request_status" diet.diet_request.pk %}"
                                  class='form'
                                  method='POST'>
                                {% csrf_token %}
                                <button type="submit"
                                        class='btn btn-sm btn text-light'
                                        style="background-color:var(--bs-gray)">
                                    {% trans "Request an update" %}
                                </button>
                            </form>
                        {% endif %}
                    </div>

                    <div class="container-fluid">
                        {% if diet.notes %}
                            <h3 class='fs-bold text-light bg-primary p-2 text-center'>
                                {% trans "Additional Notes" %}
                            </h3>
                            <div style="margin-left:5.5rem">
                                {{ diet.notes|prepend_hyphen|linebreaks }}
                            </div>
                        {% endif %}

                        <h3 class='fs-bold text-light bg-primary p-2 text-center'>
                            {% trans "Diet Plan" %}
                        </h3>
                        <div class="row g-4">
                            {% for daily_plan in diet.daily_plans.all %}

                                <div class="col-lg-12 col-md-12 col-sm-12 mb-4 p-0">
                                    <div class="h-100 m-1 diet-card">
                                        <div class="card-header text-light">
                                            <h4 class="mb-0 text-center">
                                                {{ daily_plan.get_day_display }}
                                            </h4>
                                        </div>
                                        <div class="card-body">
                                            {% for meal in daily_plan.meals.all %}
                                                <div class="mb-3">
                                                    <div class="d-flex flex-column mb-2">
                                                        <h5 class="text-teal mb-0">
                                                            {{ meal.get_meal_type_display }}
                                                        </h5>
                                                        <small class="text-muted">
                                                            {% if meal.meal_type == 'BREAKFAST' %}
                                                                8:00 AM
                                                            {% elif meal.meal_type == 'LUNCH' %}
                                                                12:00 PM
                                                            {% elif meal.meal_type == 'SNACK' %}
                                                                4:00 PM
                                                            {% elif meal.meal_type == 'DINNER' %}
                                                                8:00 PM
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                    <p>
                                                        {{ meal.description }}
                                                    </p>
                                                </div>
                                                {% if not forloop.last %}
                                                    <hr />
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>
            {% elif patient_diet_request.update_status == 'PENDING' %}
                <div class="text-center py-4">
                    <i class="fa fa-clock-o fa-3x text-muted mb-3" aria-hidden="true"></i>
                    <h4 class="mb-3">
                        {% trans "Your Diet Plan is Being Prepared" %}
                    </h4>
                    <p class="text-muted small">
                        {% trans "Our nutrition experts are working on your personalized diet plan. Please check back soon." %}
                    </p>
                </div>
            {% elif not patient_diet_request %}
                <div class="text-center py-4">
                    <i class="fa fa-cutlery fa-3x text-teal mb-3" aria-hidden="true"></i>
                    <h4 class="mb-3">
                        {% trans "No Diet Plan Found" %}
                    </h4>
                    <p class="text-muted small mb-4">
                        {% trans "You haven't created a diet plan yet. Start your journey to better health today!" %}
                    </p>
                    <a href="{% url 'patient:bmi_calculator' %}" class="btn btn-teal btn-lg">
                        <i class="fa fa-plus me-2"></i>
                        {% trans "Create Diet Request" %}
                    </a>
                </div>
            {% endif %}
        </div>
    {% elif role == 'ADMIN' %}
        <!-- Admin Section: Enhanced design -->
        <div class="container-fluid admin-dashboard">
            <!-- Modern Stats Cards -->
            <div class="row gx-2 mb-4 equal-height-cards">
                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card stats-card-v2 bg-white border-0 shadow-sm">
                        <div class="card-body p-4">
                            <div class="d-flex flex-column h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-wrapper bg-primary">
                                        <i class="fa fa-users"></i>
                                    </div>
                                    <h6 class="text-muted mb-0 ms-3">
                                        {% trans "Total Users" %}
                                    </h6>
                                </div>
                                <h3 class="mb-3">
                                    1,234
                                </h3>
                                <div class="mt-auto">
                                    <div class="progress bg-light" style="height: 6px;">
                                        <div class="progress-bar bg-primary" style="width: 75%">
                                        </div>
                                    </div>
                                    <small class="text-muted d-block mt-2">+5% from last month</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card stats-card-v2 bg-white border-0 shadow-sm">
                        <div class="card-body p-4">
                            <div class="d-flex flex-column h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-wrapper bg-teal">
                                        <i class="fa fa-heartbeat"></i>
                                    </div>
                                    <h6 class="text-muted mb-0 ms-3">
                                        {% trans "Total Patients" %}
                                    </h6>
                                </div>
                                <h3 class="mb-3">
                                    987
                                </h3>
                                <div class="mt-auto">
                                    <div class="progress bg-light" style="height: 6px;">
                                        <div class="progress-bar bg-teal" style="width: 60%">
                                        </div>
                                    </div>
                                    <small class="text-muted d-block mt-2">+12% from last month</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card stats-card-v2 bg-white border-0 shadow-sm">
                        <div class="card-body p-4">
                            <div class="d-flex flex-column h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-wrapper bg-success">
                                        <i class="fa fa-heart"></i>
                                    </div>
                                    <h6 class="text-muted mb-0 ms-3">
                                        {% trans "Total Doctors" %}
                                    </h6>
                                </div>
                                <h3 class="mb-3">
                                    56
                                </h3>
                                <div class="mt-auto">
                                    <div class="progress bg-light" style="height: 6px;">
                                        <div class="progress-bar bg-success" style="width: 85%">
                                        </div>
                                    </div>
                                    <small class="text-muted d-block mt-2">+8% from last month</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                    <div class="card stats-card-v2 bg-white border-0 shadow-sm">
                        <div class="card-body p-4">
                            <div class="d-flex flex-column h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-wrapper bg-warning">
                                        <i class="fa fa-clipboard"></i>
                                    </div>
                                    <h6 class="text-muted mb-0 ms-3">
                                        {% trans "Active Plans" %}
                                    </h6>
                                </div>
                                <h3 class="mb-3">
                                    234
                                </h3>
                                <div class="mt-auto">
                                    <div class="progress bg-light" style="height: 6px;">
                                        <div class="progress-bar bg-warning" style="width: 45%">
                                        </div>
                                    </div>
                                    <small class="text-muted d-block mt-2">+15% from last month</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row mb-4">
                <div class="col-lg-4 col-md-12 mb-4">
                    <div class="card chart-card fade-in">
                        <div class="card-header bg-white">
                            <h5 class="card-title">
                                {% trans "User Growth" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="userGrowthChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-12 mb-4">
                    <div class="card chart-card fade-in">
                        <div class="card-header bg-white">
                            <h5 class="card-title">
                                {% trans "User Distribution" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="userDistributionChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-12 mb-4">
                    <div class="card chart-card fade-in">
                        <div class="card-header bg-white">
                            <h5 class="card-title">
                                {% trans "Activity Overview" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="activityOverviewChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="users-section bg-white rounded">
                <div class="section-header">
                    <h2 class="section-title">
                        User Management
                    </h2>
                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" placeholder="Search users..." class="search-input" />
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>

                <div class="users-grid">
                    {% for user in users %}
                        <div class="user-card bg-light">
                            <div class="user-avatar">
                                <img src="{{ user.profile.image.url }}" alt="{{ user.username }}" />
                            </div>
                            <div class="user-info">
                                <h3 class="username">
                                    {{ user.username }}
                                </h3>
                                <p class="user-email">
                                    {{ user.email }}
                                </p>
                                <div class="user-meta">
                                    <span class="user-role">{{ user.profile.get_role_display }}</span>
                                    <span class="user-status {% if user.is_active %}active{% else %}inactive{% endif %}">
                                        {{ user.is_active|yesno:"Active,Inactive" }}
                                    </span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <button class="btn-action delete-btn delete-button"
                                        title="Delete User"
                                        data-delete-url="{% url "dash:delete_user" user.pk %}"
                                        data-csrf-token="{{ csrf_token }}"
                                        data-url="{% url 'dash:delete_user' user.pk %}">
                                    <i class="fa fa-trash"></i>
                                </button>
                                <a class="btn-action view-btn" title="View Profile" href="{% url "dash:user-details" user.pk %}">
                                    <i class="fa fa-eye"></i>
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="pagination-controls">
                    <button class="btn-pagination prev-btn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="page-indicator">Page 1 of 5</span>
                    <button class="btn-pagination next-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    {% endif %}


{% endblock dash %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/admin_dashboard.js' %}?v={% now 'U' %}"></script>
{% endblock extra_js %}
